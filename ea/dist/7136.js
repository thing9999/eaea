"use strict";(self.webpackChunkvolumetric_atmospheric_scattering=self.webpackChunkvolumetric_atmospheric_scattering||[]).push([[7136,9928],{7027:(e,t,r)=>{r.d(t,{ux:()=>g,cU:()=>h,o5:()=>x,ow:()=>b});var n=r(998),a=r(4037),i=r(4867),o=r(7517),s=r(854),l=r(2667),u=(r(6931),r(7891)),c=r(1137);r(8864),r(9928);var p=r(6755);l.t.prototype.forceSphericalPolynomialsRecompute=function(){this._texture&&(this._texture._sphericalPolynomial=null,this._texture._sphericalPolynomialPromise=null,this._texture._sphericalPolynomialComputed=!1)},Object.defineProperty(l.t.prototype,"sphericalPolynomial",{get:function(){if(this._texture){if(this._texture._sphericalPolynomial||this._texture._sphericalPolynomialComputed)return this._texture._sphericalPolynomial;if(this._texture.isReady)return this._texture._sphericalPolynomialPromise||(this._texture._sphericalPolynomialPromise=p.d.ConvertCubeMapTextureToSphericalPolynomial(this),null===this._texture._sphericalPolynomialPromise?this._texture._sphericalPolynomialComputed=!0:this._texture._sphericalPolynomialPromise.then(e=>{this._texture._sphericalPolynomial=e,this._texture._sphericalPolynomialComputed=!0})),null}return null},set:function(e){this._texture&&(this._texture._sphericalPolynomial=e)},enumerable:!0,configurable:!0});const d="image/png",m=2,f=[134,22,135,150,246,214,150,54];function h(e){const t=new DataView(e.buffer,e.byteOffset,e.byteLength);let r=0;for(let e=0;e<f.length;e++)if(t.getUint8(r++)!==f[e])return c.V.Error("Not a babylon environment map"),null;let n="",a=0;for(;a=t.getUint8(r++);)n+=String.fromCharCode(a);let i=JSON.parse(n);return i=y(i),i.binaryDataPosition=r,i.specular&&(i.specular.lodGenerationScale=i.specular.lodGenerationScale||.8),i}function y(e){if(e.version>m)throw new Error(`Unsupported babylon environment map version "${e.version}". Latest supported version is "${m}".`);return 2===e.version?e:e={...e,version:2,imageType:d}}function g(e,t){const r=(t=y(t)).specular;let n=Math.log2(t.width);if(n=Math.round(n)+1,r.mipmaps.length!==6*n)throw new Error(`Unsupported specular mipmaps number "${r.mipmaps.length}"`);const a=new Array(n);for(let i=0;i<n;i++){a[i]=new Array(6);for(let n=0;n<6;n++){const o=r.mipmaps[6*i+n];a[i][n]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+o.position,o.length)}}return a}function x(e,t,r){const n=(r=y(r)).specular;if(!n)return Promise.resolve([]);e._lodGenerationScale=n.lodGenerationScale;const i=[],o=g(t,r);i.push(async function(e,t,r=d){const n=e.getEngine();e.format=5,e.type=0,e.generateMipMaps=!0,e._cachedAnisotropicFilteringLevel=null,n.updateTextureSamplingMode(3,e),await _(e,t,!0,r),e.isReady=!0}(e,o,r.imageType));const u=r.irradiance?.irradianceTexture;if(u){const n=function(e,t){t=y(t);const r=new Array(6),n=t.irradiance?.irradianceTexture;if(n){if(6!==n.faces.length)throw new Error(`Incorrect irradiance texture faces number "${n.faces.length}"`);for(let a=0;a<6;a++){const i=n.faces[a];r[a]=new Uint8Array(e.buffer,e.byteOffset+t.binaryDataPosition+i.position,i.length)}}return r}(t,r);let o=null;r.irradiance?.irradianceTexture?.dominantDirection&&(o=a.Pq.FromArray(r.irradiance.irradianceTexture.dominantDirection)),i.push(async function(e,t,r,n=d,a=null){const i=e.getEngine(),o=new s.h(i,5),u=new l.t(i,o);e._irradianceTexture=u,u._dominantDirection=a,o.isCube=!0,o.format=5,o.type=0,o.generateMipMaps=!0,o._cachedAnisotropicFilteringLevel=null,o.generateMipMaps=!0,o.width=r,o.height=r,i.updateTextureSamplingMode(3,o),await _(o,[t],!1,n),i.generateMipMapsForCubemap(o),o.isReady=!0}(e,n,u.size,r.imageType,o))}return Promise.all(i)}async function w(e,t,r,n,a,i,o,s,l,u,c){return await new Promise((p,d)=>{if(r){const r=t.createTexture(null,!0,!0,null,1,null,e=>{d(e)},e);n?.onEffectCreatedObservable.addOnce(s=>{s.executeWhenCompiled(()=>{n.externalTextureSamplerBinding=!0,n.onApply=n=>{n._bindTexture("textureSampler",r),n.setFloat2("scale",1,t._features.needsInvertingBitmap&&e instanceof ImageBitmap?-1:1)},t.scenes.length&&(t.scenes[0].postProcessManager.directRender([n],u,!0,i,o),t.restoreDefaultFramebuffer(),r.dispose(),URL.revokeObjectURL(a),p())})})}else{if(t._uploadImageToTexture(c,e,i,o),s){const r=l[o];r&&t._uploadImageToTexture(r._texture,e,i,0)}p()}})}async function _(e,t,a,o=d){if(!n.S0.IsExponentOfTwo(e.width))throw new Error("Texture size must be a power of two");const c=(0,i.C0)(e.width)+1,p=e.getEngine();let m=!1,f=!1,h=null,y=null,g=null;const x=p.getCaps();x.textureLOD?p._features.supportRenderAndCopyToLodForFloatTextures?x.textureHalfFloatRender&&x.textureHalfFloatLinearFiltering?(m=!0,e.type=2):x.textureFloatRender&&x.textureFloatLinearFiltering&&(m=!0,e.type=1):m=!1:(m=!1,f=a);let _=0;if(m)p.isWebGPU?(_=1,await r.e(371).then(r.bind(r,371))):await r.e(9682).then(r.bind(r,9682)),h=new u.w("rgbdDecode","rgbdDecode",null,null,1,null,3,p,!1,void 0,e.type,void 0,null,!1,void 0,_),e._isRGBD=!1,e.invertY=!1,y=p.createRenderTargetCubeTexture(e.width,{generateDepthBuffer:!1,generateMipMaps:!0,generateStencilBuffer:!1,samplingMode:3,type:e.type,format:5});else if(e._isRGBD=!0,e.invertY=!0,f){const t=3;g={};const r=e._lodGenerationScale,n=e._lodGenerationOffset;for(let a=0;a<t;a++){const i=(c-1)*r+n,o=n+(i-n)*(1-a/(t-1)),u=Math.round(Math.min(Math.max(o,0),i)),d=new s.h(p,2);d.isCube=!0,d.invertY=!0,d.generateMipMaps=!1,p.updateTextureSamplingMode(2,d);const m=new l.t(null);switch(m._isCube=!0,m._texture=d,g[u]=m,a){case 0:e._lodTextureLow=m;break;case 1:e._lodTextureMid=m;break;case 2:e._lodTextureHigh=m}}}const b=[];for(let r=0;r<t.length;r++)for(let n=0;n<6;n++){const a=t[r][n],i=new Blob([a],{type:o}),s=URL.createObjectURL(i);let l;if(p._features.forceBitmapOverHTMLImageElement)l=p.createImageBitmap(i,{premultiplyAlpha:"none"}).then(async t=>await w(t,p,m,h,s,n,r,f,g,y,e));else{const t=new Image;t.src=s,l=new Promise((a,i)=>{t.onload=()=>{w(t,p,m,h,s,n,r,f,g,y,e).then(()=>a()).catch(e=>{i(e)})},t.onerror=e=>{i(e)}})}b.push(l)}if(await Promise.all(b),t.length<c){let r;const n=Math.pow(2,c-1-t.length),a=n*n*4;switch(e.type){case 0:r=new Uint8Array(a);break;case 2:r=new Uint16Array(a);break;case 1:r=new Float32Array(a)}for(let n=t.length;n<c;n++)for(let t=0;t<6;t++)p._uploadArrayBufferViewToTexture(y?.texture||e,r,t,n)}if(y){const t=e._irradianceTexture;e._irradianceTexture=null,p._releaseTexture(e),y._swapAndDie(e),e._irradianceTexture=t}h&&h.dispose(),f&&(e._lodTextureHigh&&e._lodTextureHigh._texture&&(e._lodTextureHigh._texture.isReady=!0),e._lodTextureMid&&e._lodTextureMid._texture&&(e._lodTextureMid._texture.isReady=!0),e._lodTextureLow&&e._lodTextureLow._texture&&(e._lodTextureLow._texture.isReady=!0))}function b(e,t){const r=(t=y(t)).irradiance;if(!r)return;const n=new o.Q;a.Pq.FromArrayToRef(r.x,0,n.x),a.Pq.FromArrayToRef(r.y,0,n.y),a.Pq.FromArrayToRef(r.z,0,n.z),a.Pq.FromArrayToRef(r.xx,0,n.xx),a.Pq.FromArrayToRef(r.yy,0,n.yy),a.Pq.FromArrayToRef(r.zz,0,n.zz),a.Pq.FromArrayToRef(r.yz,0,n.yz),a.Pq.FromArrayToRef(r.zx,0,n.zx),a.Pq.FromArrayToRef(r.xy,0,n.xy),e._sphericalPolynomial=n}},7136:(e,t,r)=>{r.r(t),r.d(t,{_ENVTextureLoader:()=>a});var n=r(7027);class a{constructor(){this.supportCascades=!1}loadCubeData(e,t,r,a,i){if(Array.isArray(e))return;const o=(0,n.cU)(e);if(o){t.width=o.width,t.height=o.width;try{(0,n.ow)(t,o),(0,n.o5)(t,e,o).then(()=>{t.isReady=!0,t.onLoadedObservable.notifyObservers(t),t.onLoadedObservable.clear(),a&&a()},e=>{i?.("Can not upload environment levels",e)})}catch(e){i?.("Can not upload environment file",e)}}else i&&i("Can not parse the environment file",null)}loadData(){throw".env not supported in 2d."}}},9928:(e,t,r)=>{r.r(t),r.d(t,{Dispose:()=>d,DumpData:()=>p,DumpDataAsync:()=>c,DumpFramebuffer:()=>u,DumpTools:()=>m});var n=r(4255),a=r(998),i=r(4867),o=r(6315),s=r(1137);let l=null;async function u(e,t,r,n,a="image/png",i,o){const s=await r.readPixels(0,0,e,t);p(e,t,new Uint8Array(s.buffer),n,a,i,!0,void 0,o)}async function c(e,t,u,c="image/png",p,m=!1,f=!1,h){if(u instanceof Float32Array){const e=new Uint8Array(u.length);let t=u.length;for(;t--;){const r=u[t];e[t]=Math.round(255*(0,i.OQ)(r))}u=e}const y=await async function(){return l||(l=async function(){const e=o.q.LastCreatedEngine?.createCanvas(100,100)??new OffscreenCanvas(100,100);e instanceof OffscreenCanvas&&s.V.Warn("DumpData: OffscreenCanvas will be used for dumping data. This may result in lossy alpha values.");const{ThinEngine:t}=await Promise.resolve().then(r.bind(r,6514));if(!t.IsSupported){if(!e.getContext("bitmaprenderer"))throw new Error("DumpData: No WebGL or bitmap rendering context available. Cannot dump data.");return{canvas:e}}const a=new t(e,!1,{preserveDrawingBuffer:!0,depth:!1,stencil:!1,alpha:!0,premultipliedAlpha:!1,antialias:!1,failIfMajorPerformanceCaveat:!1});o.q.Instances.pop(),o.q.OnEnginesDisposedObservable.add(e=>{a&&e!==a&&!a.isDisposed&&0===o.q.Instances.length&&d()}),a.getCaps().parallelShaderCompile=void 0;const i=new n.J(a),{passPixelShader:l}=await r.e(9820).then(r.bind(r,9820)),u=new n.$({engine:a,name:l.name,fragmentShader:l.shader,samplerNames:["textureSampler"]});return{canvas:e,dumpEngine:{engine:a,renderer:i,wrapper:u}}}()),await l}();return await new Promise(async r=>{if(y.dumpEngine){const r=y.dumpEngine;r.engine.setSize(e,t,!0);const n=r.engine.createRawTexture(u,e,t,5,!1,!m,1);r.renderer.setViewport(),r.renderer.applyEffectWrapper(r.wrapper),r.wrapper.effect._bindTexture("textureSampler",n),r.renderer.draw(),n.dispose()}else{const r=y.canvas.getContext("bitmaprenderer");y.canvas.width=e,y.canvas.height=t;const n=new ImageData(e,t);n.data.set(u);const a=await createImageBitmap(n,{premultiplyAlpha:"none",imageOrientation:m?"flipY":"from-image"});r.transferFromImageBitmap(a)}a.S0.ToBlob(y.canvas,e=>{if(!e)throw new Error("DumpData: Failed to convert canvas to blob.");void 0!==p&&a.S0.DownloadBlob(e,p);const t=new FileReader;t.onload=e=>{const t=e.target.result;r(t)},f?t.readAsArrayBuffer(e):t.readAsDataURL(e)},c,h)})}function p(e,t,r,n,a="image/png",i,o=!1,s=!1,l){void 0!==i||n||(i=""),c(e,t,r,a,i,o,s,l).then(e=>{n&&n(e)})}function d(){l&&(l?.then(e=>{e.canvas instanceof HTMLCanvasElement&&e.canvas.remove(),e.dumpEngine&&(e.dumpEngine.engine.dispose(),e.dumpEngine.renderer.dispose(),e.dumpEngine.wrapper.dispose())}),l=null)}const m={DumpData:p,DumpDataAsync:c,DumpFramebuffer:u,Dispose:d};a.S0.DumpData=p,a.S0.DumpDataAsync=c,a.S0.DumpFramebuffer=u}}]);